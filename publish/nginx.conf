# load_module /usr/lib64/nginx/modules/ngx_stream_module.so;

user  nginx;
worker_processes     auto;
worker_cpu_affinity  auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events{
	use epoll;
	worker_connections 65535;
}

http {
	include       /etc/nginx/mime.types;
	default_type  application/octet-stream;

	log_format  main  '$http_x_forwarded_for - $remote_user [$time_local] "$request" '
				'$status $body_bytes_sent "$http_referer" '
				'"$http_user_agent"';
	access_log    /var/log/nginx/access.log  main;
	error_log     /var/log/nginx/error.log    debug;

	sendfile        on;
	keepalive_timeout  65;
	tcp_nodelay on; 
	client_max_body_size 50m;#上传文件大小限制 

	proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=content:20m inactive=1d max_size=100m;  
	gzip on;
	gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
	gzip_vary on;
	gzip_proxied any;
	gzip_min_length 1k;
	gzip_buffers 16 8k;
	gzip_http_version 1.1;
	gzip_comp_level 6;
	gzip_disable "msie6";

	output_buffers 1 32k;
	postpone_output 1460;

	#IP白名单
	geo $whiteiplist  {
		default 1;
		127.0.0.1 0;
		10.0.0.0/8 0;
		121.207.242.0/24 0;
	}

	# 这里取得原始用户的IP地址
	map $http_x_forwarded_for  $RealIp {
		""    $remote_addr;
		~^([0-9\.]+),?.*$    $1;  # 修正正则表达式
	}
 
	# 设定负载均衡后台服务器列表    
	upstream  net78{ 
		ip_hash; #互联网项目
		# Docker 环境下的 Node.js 服务
		server   nodejs-app-1:88 max_fails=2 fail_timeout=10s;
		server   nodejs-app-2:88 max_fails=2 fail_timeout=10s;
		keepalive 256;
	}

	server {
		listen       80;
		server_name  localhost;

		#配置1秒的缓存 大幅提升吞吐量
		proxy_cache content;
		proxy_cache_lock on;
		proxy_cache_valid 200 2s;
		proxy_cache_use_stale updating;

		location =/ {
			root   /usr/share/nginx/html;
			index  index.html;
		}

		location ~* \.(ico|gif|bmp|jpg|jpeg|png|swf|js|css|mp3) {
			root    /usr/share/nginx/html;
			expires 3m;
		}

		location / {
			root /usr/share/nginx/html;
			expires 3m;
			index  index.html;
		}

		location ^~/Scripts {
			root    /usr/share/nginx/html;    
			expires 3m;
		}

		location ^~/Content {
			root    /usr/share/nginx/html;    
			expires 3m;
		}

		# 健康检查端点 - 直接访问应用的test接口
		location = /health {
			access_log off;
			proxy_pass http://net78/Api7822/TestMenu/Test78/test;
			proxy_set_header Host $host;
			proxy_set_header X-Real-IP $remote_addr;
			proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
			proxy_connect_timeout 2s;
			proxy_send_timeout 2s;
			proxy_read_timeout 2s;
		}

		location ^~/Api7822/ {
			add_header Access-Control-Allow-Origin *;
			add_header Access-Control-Allow-Methods 'GET, POST, OPTIONS';
			add_header Access-Control-Allow-Headers 'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';

			proxy_set_header x-forwarded-for $RealIp;
			proxy_pass http://net78;
			proxy_redirect off;   
			proxy_http_version 1.1;
			proxy_set_header Connection "Keep-Alive";
			proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;        
		}
	 
		#error_page  404              /404.html;

		# redirect server error pages to the static page /50x.html
		error_page   500 502 503 504  /50x.html;
		location = /50x.html {
			root   /usr/share/nginx/html;
		} 
	} 
}